# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–∂–¥—É –ø—Ä–æ–¥–æ–º –∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π

## üö® –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ù–∞ –ø—Ä–æ–¥–µ: 6529 –æ–±–Ω–æ–≤–∏—Ç—å + 5331 –∏–≥–Ω–æ—Ä–∏—Ç—å = 11860
- –õ–æ–∫–∞–ª—å–Ω–æ: 11285 –æ–±–Ω–æ–≤–∏—Ç—å + 575 –∏–≥–Ω–æ—Ä–∏—Ç—å = 11860
- –í –ª–æ–≥–∞—Ö –Ω–∞ –ø—Ä–æ–¥–µ: `An I/O error occurred while sending to the backend`, `–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î`

**–ü—Ä–∏—á–∏–Ω–∞:** 
–ü–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å PostgreSQL –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∞–Ω–∞–ª–∏–∑–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤. –ö–æ–≥–¥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è, ~5000 –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ –æ—à–∏–±–æ—á–Ω–æ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å" –≤–º–µ—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –∞–Ω–∞–ª–∏–∑–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤

**–§–∞–π–ª:** `data_service.py`

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º –∫–∞–∂–¥–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ –ë–î

**–§–∞–π–ª:** `database_manager.py` 

- ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (connection, socket, timeout, backend)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç

**–§–∞–π–ª:** `db_connection_test.py`

–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥–µ.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:**
```bash
cd /path/to/metarep
python3 db_connection_test.py
```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
   - –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   - –¢–µ—Å—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ a_log (–∏–º–∏—Ç–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏)
   - –î–ª–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (30 —Å–µ–∫)
   - –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞—Ç—Ä–∏–±—É—Ç–æ–≤:**
```
http://10.3.0.126:5002/attributes?page=1&per_page=20&search=&status_variance=2&event=0&a_priznak=3&base_url=&source_base_url=&analyze_exceptions=true
```

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ü–∏—Ñ—Ä—ã –Ω–∞ –ø—Ä–æ–¥–µ –¥–æ–ª–∂–Ω—ã —Å—Ç–∞—Ç—å:
- **–û–±–Ω–æ–≤–∏—Ç—å:** ~11285 (–≤–º–µ—Å—Ç–æ 6529)
- **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å:** ~575 (–≤–º–µ—Å—Ç–æ 5331)
- **–í—Å–µ–≥–æ:** 11860

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –í –ª–æ–≥–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–º–æ—Ç—Ä–∏—Ç–µ:

**–•–æ—Ä–æ—à–∏–µ —Å–∏–≥–Ω–∞–ª—ã:**
```
[DEBUG] –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ
[DEBUG] Total attributes found: 11860
[DEBUG] –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å=575, –æ–±–Ω–æ–≤–∏—Ç—å=11285
```

**–ü–ª–æ—Ö–∏–µ —Å–∏–≥–Ω–∞–ª—ã:**
```
[DEBUG] –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è ...: –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
[DEBUG] –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
An I/O error occurred while sending to the backend
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–¢–∞–π–º–∞—É—Ç—ã –≤ postgresql.conf:**
```
statement_timeout = 300s          # 5 –º–∏–Ω—É—Ç
idle_in_transaction_session_timeout = 600s  # 10 –º–∏–Ω—É—Ç
tcp_keepalives_idle = 600         # 10 –º–∏–Ω—É—Ç
tcp_keepalives_interval = 30      # 30 —Å–µ–∫—É–Ω–¥
tcp_keepalives_count = 3          # 3 –ø–æ–ø—ã—Ç–∫–∏
```

2. **–ü—É–ª—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**
```
max_connections = 200
shared_preload_libraries = 'pg_stat_statements'
```

3. **–†–µ—Å—É—Ä—Å—ã:**
```
work_mem = 256MB
effective_cache_size = 4GB
random_page_cost = 1.1
```

## üöÄ –î–µ–ø–ª–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ß–µ—Ä–µ–∑ Docker:

1. **–ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑:**
```bash
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml build --no-cache
docker-compose -f docker-compose.prod.yml up -d
```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
```bash
docker-compose -f docker-compose.prod.yml logs -f app
```

### –ë–µ–∑ Docker:

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
```bash
pkill -f "python.*app.py"
python3 app.py
```

## üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏

1. ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
2. ‚úÖ –¶–∏—Ñ—Ä—ã –Ω–∞ –ø—Ä–æ–¥–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ (~11285 –æ–±–Ω–æ–≤–∏—Ç—å, ~575 –∏–≥–Ω–æ—Ä–∏—Ç—å)
3. ‚úÖ –í –ª–æ–≥–∞—Ö –Ω–µ—Ç –º–∞—Å—Å–æ–≤—ã—Ö –æ—à–∏–±–æ–∫ "–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î"
4. ‚úÖ –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã

## üìû –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞—é—Ç—Å—è

1. **–°–æ–±–µ—Ä–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:**
```bash
python3 db_connection_test.py > db_diagnostic.log 2>&1
```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:**
   - Firewall –º–µ–∂–¥—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –∏ PostgreSQL
   - Load balancer –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
   - Proxy timeout –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ PostgreSQL:**
```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
SELECT count(*) FROM pg_stat_activity;

-- –î–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã  
SELECT query, state, query_start 
FROM pg_stat_activity 
WHERE state != 'idle' 
ORDER BY query_start;
```

---

**üîÑ –í–µ—Ä—Å–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 2025-01-22
**üìä –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞ –ø—Ä–æ–¥–µ, —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î 